# æ¶ˆæ¯é˜Ÿåˆ—è®¾è®¡ï¼šä»åŸç†åˆ°å®æˆ˜ (Interactive Guide to Message Queues)

> ğŸ’¡ **å­¦ä¹ æŒ‡å—**ï¼šæœ¬ç« èŠ‚å¸¦ä½ æ·±å…¥ç†è§£åç«¯ç³»ç»Ÿçš„"ç¼“å†²å™¨"â€”â€”æ¶ˆæ¯é˜Ÿåˆ—ã€‚æˆ‘ä»¬å°†ä»æœ€åŸºç¡€çš„"ä¸ºä»€ä¹ˆè¦ç”¨é˜Ÿåˆ—"è®²èµ·ï¼Œä¸€æ­¥æ­¥æŒæ¡æ¶ˆæ¯é˜Ÿåˆ—çš„æ ¸å¿ƒæ¨¡å¼ã€å¯é æ€§ä¿è¯ã€ä»¥åŠå®æˆ˜ä¸­çš„æ¶æ„è®¾è®¡ã€‚

<MessageQueueDemo />

## 0. å¼•è¨€ï¼šç³»ç»Ÿçš„"ç¼“å†²å™¨"

ä½ åœ¨æ·˜å®ä¹°å®Œä¸œè¥¿ï¼Œä¸ºä»€ä¹ˆç‚¹å‡»"æ”¯ä»˜"åï¼Œä¸ä¼šç«‹åˆ»æ”¶åˆ°çŸ­ä¿¡é€šçŸ¥ï¼Ÿ
ä½ åœ¨æŠ–éŸ³å‘äº†ä¸€æ¡è¯„è®ºï¼Œä¸ºä»€ä¹ˆç‚¹èµæ•°ä¸æ˜¯ç¬é—´å°±å¢åŠ ï¼Ÿ

è¿™èƒŒåéƒ½æœ‰ä¸€ä¸ªåŠŸè‡£ï¼š**æ¶ˆæ¯é˜Ÿåˆ— (Message Queue)**ã€‚

å¦‚æœåŒæ­¥è°ƒç”¨æ˜¯"æ‰“ç”µè¯"ï¼Œé‚£æ¶ˆæ¯é˜Ÿåˆ—å°±æ˜¯"å‘å¾®ä¿¡"ã€‚
æ‰“ç”µè¯è¦æ±‚å¯¹æ–¹**ç«‹å³å“åº”**ï¼ˆåŒæ­¥ï¼‰ï¼Œå‘å¾®ä¿¡å¯ä»¥ç­‰å¯¹æ–¹**ç¨åå¤„ç†**ï¼ˆå¼‚æ­¥ï¼‰ã€‚

### 0.1 ä¸ºä»€ä¹ˆè¦ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ

åªæœ‰ä¸€ä¸ªç†ç”±ï¼š**è§£è€¦å’Œå‰Šå³°**ã€‚

- **è§£è€¦**ï¼šA ä¸éœ€è¦ç›´æ¥è°ƒç”¨ Bï¼ŒæŠŠæ¶ˆæ¯æ‰”ç»™é˜Ÿåˆ—å°±å®Œäº‹äº†ã€‚
  - _ä¾‹å­_ï¼šç”¨æˆ·ä¸‹å•åï¼Œè®¢å•æœåŠ¡ä¸éœ€è¦ç›´æ¥è°ƒç”¨åº“å­˜ã€ç§¯åˆ†ã€é€šçŸ¥æœåŠ¡ï¼Œè€Œæ˜¯å‘ä¸€æ¡"ä¸‹å•æˆåŠŸ"æ¶ˆæ¯ã€‚
- **å‰Šå³°**ï¼šæŠŠç¬é—´çš„é«˜å³°æµé‡"æ‘Šå¹³"ï¼Œé¿å…ç³»ç»Ÿè¢«æ‰“çˆ†ã€‚
  - _ä¾‹å­_ï¼šç§’æ€æ´»åŠ¨ï¼Œ1 ç§’å†…æœ‰ 10 ä¸‡ä¸ªè¯·æ±‚ï¼Œä½†æ•°æ®åº“åªèƒ½å¤„ç† 1000 ä¸ªã€‚é˜Ÿåˆ—æŠŠè¿™ 10 ä¸‡ä¸ªè¯·æ±‚æš‚å­˜èµ·æ¥ï¼Œæ…¢æ…¢å¤„ç†ã€‚

<PeakShavingDemo />

**å…³é”®ç‚¹**ï¼šæ¶ˆæ¯é˜Ÿåˆ—çš„æœ¬è´¨æ˜¯**å¼‚æ­¥é€šä¿¡**ï¼Œé€šè¿‡æŠŠ"ç«‹å³æ‰§è¡Œ"å˜æˆ"ç¨åå¤„ç†"ï¼Œæå‡ç³»ç»Ÿçš„ååé‡å’Œå¯ç”¨æ€§ã€‚

---

## 1. ç¬¬ä¸€æ­¥ï¼šç†è§£æ¶ˆæ¯é˜Ÿåˆ—çš„æ ¸å¿ƒæ¦‚å¿µ

### 1.1 æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸‰è¦ç´ 

1.  **ç”Ÿäº§è€… (Producer)**ï¼šå‘é€æ¶ˆæ¯çš„ä¸€æ–¹ã€‚
    - _ä¾‹å­_ï¼šè®¢å•æœåŠ¡ï¼ˆä¸‹å•æˆåŠŸåå‘é€æ¶ˆæ¯ï¼‰ã€‚
2.  **æ¶ˆæ¯ä»£ç† (Broker)**ï¼šå­˜å‚¨å’Œè½¬å‘æ¶ˆæ¯çš„ä¸­ä»‹ã€‚
    - _ä¾‹å­_ï¼šRabbitMQã€Kafkaã€RocketMQã€‚
3.  **æ¶ˆè´¹è€… (Consumer)**ï¼šæ¥æ”¶å¹¶å¤„ç†æ¶ˆæ¯çš„ä¸€æ–¹ã€‚
    - _ä¾‹å­_ï¼šåº“å­˜æœåŠ¡ï¼ˆæ‰£å‡åº“å­˜ï¼‰ã€çŸ­ä¿¡æœåŠ¡ï¼ˆå‘é€é€šçŸ¥ï¼‰ã€‚

<MessageQueueComponentsDemo />

### 1.2 æ¶ˆæ¯æ¨¡å¼ (Messaging Patterns)

#### ç‚¹å¯¹ç‚¹ (Point-to-Point)

ä¸€æ¡æ¶ˆæ¯åªèƒ½è¢«**ä¸€ä¸ªæ¶ˆè´¹è€…**æ¶ˆè´¹ã€‚

- _åœºæ™¯_ï¼šä»»åŠ¡åˆ†é…ï¼ˆå¦‚æ‰¹é‡å¯¼å…¥ Excelï¼Œåˆ†å‘ç»™å¤šä¸ªå·¥ä½œèŠ‚ç‚¹å¤„ç†ï¼‰ã€‚
- _ç‰¹ç‚¹_ï¼šè´Ÿè½½å‡è¡¡ï¼Œå¤šä¸ªæ¶ˆè´¹è€…ç«äº‰æ¶ˆè´¹ã€‚

#### å‘å¸ƒè®¢é˜… (Pub/Sub)

ä¸€æ¡æ¶ˆæ¯å¯ä»¥è¢«**å¤šä¸ªæ¶ˆè´¹è€…**åŒæ—¶æ¶ˆè´¹ã€‚

- _åœºæ™¯_ï¼šäº‹ä»¶é€šçŸ¥ï¼ˆå¦‚ç”¨æˆ·æ³¨å†Œåï¼ŒåŒæ—¶å‘é‚®ä»¶ã€å‘çŸ­ä¿¡ã€å‘æ”¾ä¼˜æƒ åˆ¸ï¼‰ã€‚
- _ç‰¹ç‚¹_ï¼šå¹¿æ’­ï¼Œæ¯ä¸ªè®¢é˜…è€…éƒ½èƒ½æ”¶åˆ°å®Œæ•´æ¶ˆæ¯ã€‚

<PointToPointVsPubSubDemo />

**å…³é”®ç‚¹**ï¼šç‚¹å¯¹ç‚¹æ˜¯"ä»»åŠ¡åˆ†é…"ï¼Œå‘å¸ƒè®¢é˜…æ˜¯"äº‹ä»¶é€šçŸ¥"ã€‚

---

## 2. ä¸»æµæ¶ˆæ¯é˜Ÿåˆ—å¯¹æ¯”

| ç‰¹æ€§         | RabbitMQ           | Kafka              | RocketMQ            | Redis Stream     |
| :----------- | :----------------- | :----------------- | :------------------ | :--------------- |
| **å®šä½**     | ä¼ ç»Ÿæ¶ˆæ¯é˜Ÿåˆ—       | åˆ†å¸ƒå¼æ—¥å¿—ç³»ç»Ÿ     | ç”µå•†çº§æ¶ˆæ¯é˜Ÿåˆ—      | è½»é‡çº§é˜Ÿåˆ—       |
| **ååé‡**   | ~1 ä¸‡/ç§’           | ~100 ä¸‡/ç§’         | ~10 ä¸‡/ç§’           | ~5 ä¸‡/ç§’         |
| **å»¶è¿Ÿ**     | å¾®ç§’çº§             | æ¯«ç§’çº§             | æ¯«ç§’çº§              | æ¯«ç§’çº§           |
| **å¯é æ€§**   | é«˜ï¼ˆæŒä¹…åŒ–ï¼‰       | é«˜ï¼ˆå¤šå‰¯æœ¬ï¼‰       | é«˜ï¼ˆåŒæ­¥/å¼‚æ­¥åˆ·ç›˜ï¼‰ | ä¸­ï¼ˆAOF æŒä¹…åŒ–ï¼‰ |
| **æ¶ˆæ¯é¡ºåº** | æ”¯æŒï¼ˆå•é˜Ÿåˆ—ï¼‰     | æ”¯æŒï¼ˆåˆ†åŒºå†…ï¼‰     | æ”¯æŒ                | æ”¯æŒ             |
| **æ¶ˆæ¯å›æº¯** | ä¸æ”¯æŒ             | æ”¯æŒ               | æ”¯æŒ                | æ”¯æŒ             |
| **å­¦ä¹ æ›²çº¿** | ä¸­                 | é«˜                 | é«˜                  | ä½               |
| **é€‚ç”¨åœºæ™¯** | ä¼ ç»Ÿä¸šåŠ¡ã€ä»»åŠ¡é˜Ÿåˆ— | æ—¥å¿—æ”¶é›†ã€æµå¼å¤„ç† | ç”µå•†ã€é‡‘è          | å°è§„æ¨¡ã€ç®€å•é˜Ÿåˆ— |

### 2.1 å¦‚ä½•é€‰æ‹©ï¼Ÿ

- **RabbitMQ**ï¼š
  - âœ… éœ€è¦å¤æ‚çš„è·¯ç”±è§„åˆ™ï¼ˆå¦‚æ ¹æ®è®¢å•ç±»å‹åˆ†å‘åˆ°ä¸åŒé˜Ÿåˆ—ï¼‰ã€‚
  - âœ… å¯¹å»¶è¿Ÿæ•æ„Ÿï¼ˆè¦æ±‚å¾®ç§’çº§å“åº”ï¼‰ã€‚
  - âœ… å›¢é˜Ÿç†Ÿæ‚‰ AMQP åè®®ã€‚

- **Kafka**ï¼š
  - âœ… ååé‡æå¤§ï¼ˆç™¾ä¸‡çº§ TPSï¼‰ã€‚
  - âœ… éœ€è¦æ¶ˆæ¯å›æº¯ï¼ˆé‡æ–°æ¶ˆè´¹å†å²æ•°æ®ï¼‰ã€‚
  - âœ… å¤§æ•°æ®ç”Ÿæ€ï¼ˆFlinkã€Spark é›†æˆï¼‰ã€‚

- **RocketMQ**ï¼š
  - âœ… ç”µå•†ã€äº¤æ˜“åœºæ™¯ï¼ˆäº‹åŠ¡æ¶ˆæ¯ã€é¡ºåºæ¶ˆæ¯ï¼‰ã€‚
  - âœ… é‡‘èçº§å¯é æ€§è¦æ±‚ã€‚
  - âœ… éœ€è¦å®šæ—¶æ¶ˆæ¯ã€å»¶è¿Ÿæ¶ˆæ¯ã€‚

- **Redis Stream**ï¼š
  - âœ… å°å›¢é˜Ÿã€MVP é¡¹ç›®ã€‚
  - âœ… å·²ç»æœ‰ Redisï¼Œä¸æƒ³å¼•å…¥æ–°ç»„ä»¶ã€‚
  - âš ï¸ ä¸é€‚åˆå¯¹å¯é æ€§è¦æ±‚æé«˜çš„åœºæ™¯ã€‚

<MessageQueueComparisonDemo />

**å…³é”®ç‚¹**ï¼šæ²¡æœ‰æœ€å¥½çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåªæœ‰æœ€é€‚åˆçš„ã€‚åˆå­¦è€…å¯ä»¥ä» RabbitMQ æˆ– Redis Stream å…¥æ‰‹ã€‚

---

## 3. æ ¸å¿ƒè®¾è®¡æ¨¡å¼

### 3.1 å¼‚æ­¥å¤„ç† (Asynchronous Processing)

æŠŠåŒæ­¥è°ƒç”¨æ”¹æˆå¼‚æ­¥ï¼Œæå‡å“åº”é€Ÿåº¦ã€‚

**åœºæ™¯**ï¼šç”¨æˆ·æ³¨å†Œæµç¨‹

```python
# åŒæ­¥æ–¹å¼ï¼ˆæ€»è€—æ—¶ = 1500msï¼‰
def register(username, password):
    save_user(username, password)       # 300ms
    send_email(username)                 # 500ms
    send_sms(username)                   # 400ms
    give_coupon(username)                # 300ms
    return {"status": "success"}

# å¼‚æ­¥æ–¹å¼ï¼ˆæ€»è€—æ—¶ = 300msï¼‰
def register(username, password):
    save_user(username, password)        # 300ms

    # å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—ï¼Œç«‹å³è¿”å›
    mq.publish("user.registered", {
        "username": username,
        "timestamp": time.time()
    })

    return {"status": "success"}

# åå°æ¶ˆè´¹è€…ï¼ˆæ…¢æ…¢å¤„ç†ï¼‰
def handle_user_registered(data):
    send_email(data["username"])
    send_sms(data["username"])
    give_coupon(data["username"])
```

**æ•ˆæœ**ï¼šæ¥å£å“åº”æ—¶é—´ä» 1500ms é™åˆ° 300msï¼Œç”¨æˆ·ä½“éªŒå¤§å¹…æå‡ã€‚

### 3.2 å‰Šå³°å¡«è°· (Peak Shaving)

ç”¨é˜Ÿåˆ—ç¼“å†²é«˜å³°æµé‡ã€‚

**åœºæ™¯**ï¼šç§’æ€æ´»åŠ¨

```
ç”¨æˆ·è¯·æ±‚ (10 ä¸‡/ç§’)
    â†“
[ç½‘å…³å±‚] é™æµï¼šåªæ”¾è¡Œ 1 ä¸‡/ç§’
    â†“
[æ¶ˆæ¯é˜Ÿåˆ—] ç¼“å†² 9 ä¸‡/ç§’
    â†“
[è®¢å•æœåŠ¡] æŒç»­å¤„ç† 1000/ç§’
```

```python
# ç”Ÿäº§è€…ï¼šç§’æ€æ¥å£
def seckill(user_id, product_id):
    # å¿«é€Ÿæ ¡éªŒ
    if not redis.is_available(product_id):
        return {"error": "å·²å”®ç½„"}

    # æ‰”è¿›é˜Ÿåˆ—ï¼Œç«‹å³è¿”å›
    mq.publish("seckill.order", {
        "user_id": user_id,
        "product_id": product_id,
        "timestamp": time.time()
    })

    return {"status": "æ’é˜Ÿä¸­"}

# æ¶ˆè´¹è€…ï¼šåå°å¤„ç†è®¢å•
def handle_seckill_order(data):
    user_id = data["user_id"]
    product_id = data["product_id"]

    # æ‰£å‡åº“å­˜ï¼ˆæ•°æ®åº“å¯ä»¥æ…¢æ…¢å¤„ç†ï¼‰
    success = db.deduct_stock(product_id, user_id)
    if success:
        create_order(user_id, product_id)
        mq.publish("order.created", {...})
    else:
        mq.publish("order.failed", {...})
```

<SeckillQueueDemo />

**å…³é”®ç‚¹**ï¼šç”¨æˆ·ä¸éœ€è¦ç­‰å¾…çœŸå®å¤„ç†å®Œæˆï¼Œåªè¦"æ’é˜ŸæˆåŠŸ"å°±æ»¡è¶³é¢„æœŸã€‚

### 3.3 ç³»ç»Ÿè§£è€¦ (Decoupling)

æ¶ˆé™¤æœåŠ¡ä¹‹é—´çš„ç›´æ¥ä¾èµ–ã€‚

**åœºæ™¯**ï¼šè®¢å•ç³»ç»Ÿ â†’ é€šçŸ¥ç³»ç»Ÿ

```python
# ç´§è€¦åˆï¼ˆä¸å¥½ï¼‰
def create_order(user_id, product_id):
    order = db.create_order(user_id, product_id)

    # ç›´æ¥è°ƒç”¨ï¼Œå¦‚æœé€šçŸ¥æœåŠ¡æŒ‚äº†ï¼Œè®¢å•å°±åˆ›å»ºå¤±è´¥
    notification_service.send_sms(user_id, "è®¢å•åˆ›å»ºæˆåŠŸ")
    notification_service.send_email(user_id, "è®¢å•åˆ›å»ºæˆåŠŸ")

    return order

# æ¾è€¦åˆï¼ˆå¥½ï¼‰
def create_order(user_id, product_id):
    order = db.create_order(user_id, product_id)

    # å‘é€æ¶ˆæ¯ï¼Œä¸ç®¡é€šçŸ¥æœåŠ¡æ˜¯å¦åœ¨çº¿
    mq.publish("order.created", {
        "order_id": order.id,
        "user_id": user_id
    })

    return order

# é€šçŸ¥ç³»ç»Ÿç‹¬ç«‹æ¶ˆè´¹
def handle_order_created(data):
    # å¦‚æœé€šçŸ¥æœåŠ¡æŒ‚äº†ï¼Œæ¶ˆæ¯ä¼šæš‚å­˜åœ¨é˜Ÿåˆ—é‡Œï¼Œç­‰å®ƒæ¢å¤åå†å¤„ç†
    send_sms(data["user_id"], "è®¢å•åˆ›å»ºæˆåŠŸ")
    send_email(data["user_id"], "è®¢å•åˆ›å»ºæˆåŠŸ")
```

**å¥½å¤„**ï¼š

- è®¢å•ç³»ç»Ÿä¸ä¾èµ–é€šçŸ¥ç³»ç»Ÿã€‚
- å¯ä»¥éšæ—¶å¢åŠ æ–°çš„æ¶ˆè´¹è€…ï¼ˆå¦‚ç§¯åˆ†ç³»ç»Ÿã€å¤§æ•°æ®åˆ†æï¼‰ã€‚
- é€šçŸ¥ç³»ç»Ÿå‡çº§ä¸å½±å“è®¢å•ç³»ç»Ÿã€‚

<CouplingDemo />

### 3.4 æ•°æ®åˆ†å‘ (Data Distribution)

ä¸€æ¡æ¶ˆæ¯åˆ†å‘ç»™å¤šä¸ªæ¶ˆè´¹è€…ã€‚

**åœºæ™¯**ï¼šç”¨æˆ·è¡Œä¸ºåˆ†æ

```python
# ç”¨æˆ·ç‚¹å‡»äº†å•†å“
def on_product_click(user_id, product_id):
    mq.publish("user.action", {
        "type": "click",
        "user_id": user_id,
        "product_id": product_id,
        "timestamp": time.time()
    })

# æ¶ˆè´¹è€… 1ï¼šæ¨èç³»ç»Ÿï¼ˆæ›´æ–°ç”¨æˆ·ç”»åƒï¼‰
def update_user_profile(data):
    if data["type"] == "click":
        profile.add_interest(data["user_id"], data["product_id"])

# æ¶ˆè´¹è€… 2ï¼šå®æ—¶ç»Ÿè®¡ï¼ˆç‚¹å‡»é‡è®¡æ•°ï¼‰
def increment_click_count(data):
    redis.incr(f"product:{data['product_id']}:clicks")

# æ¶ˆè´¹è€… 3ï¼šæ•°æ®ä»“åº“ï¼ˆç¦»çº¿åˆ†æï¼‰
def save_to_data_warehouse(data):
    warehouse.insert("user_actions", data)
```

<PubSubDemo />

**å…³é”®ç‚¹**ï¼šå‘å¸ƒè®¢é˜…æ¨¡å¼è®©æ•°æ®å¯ä»¥"ä¸€å†™å¤šè¯»"ï¼Œæ¯ä¸ªç³»ç»Ÿå„å–æ‰€éœ€ã€‚

---

## 4. å¯é æ€§ä¿è¯

### 4.1 æ¶ˆæ¯ä¸ä¸¢å¤±

ä»ä¸‰ä¸ªç»´åº¦ä¿è¯ï¼š

#### ç”Ÿäº§è€…ä¸ä¸¢

```python
# ç¡®è®¤æœºåˆ¶ (ACK)
try:
    mq.publish_with_confirm("order.created", order_data)
    # æ”¶åˆ° Broker ç¡®è®¤åæ‰è®¤ä¸ºå‘é€æˆåŠŸ
except Exception as e:
    # å‘é€å¤±è´¥ï¼Œé‡è¯•æˆ–è®°å½•æ—¥å¿—
    log.error(f"å‘é€å¤±è´¥: {e}")
    retry_later(order_data)
```

#### Broker ä¸ä¸¢

- **æŒä¹…åŒ–**ï¼šæ¶ˆæ¯å†™å…¥ç£ç›˜ï¼Œè€Œä¸æ˜¯åªå­˜åœ¨å†…å­˜ã€‚
- **å¤šå‰¯æœ¬**ï¼šKafka çš„å¤šå‰¯æœ¬æœºåˆ¶ï¼Œä¿è¯ä¸€å°æœºå™¨æŒ‚äº†æ•°æ®ä¸ä¸¢ã€‚

```python
# Kafka é…ç½®ç¤ºä¾‹
# acks=all: æ‰€æœ‰å‰¯æœ¬éƒ½ç¡®è®¤æ‰ç®—æˆåŠŸ
producer.send(
    topic="orders",
    value=order_data,
    acks="all"  # æˆ– -1
).get()
```

#### æ¶ˆè´¹è€…ä¸ä¸¢

```python
# æ‰‹åŠ¨ç¡®è®¤ (Manual ACK)
def process_message(msg):
    try:
        # å¤„ç†ä¸šåŠ¡é€»è¾‘
        handle_order(msg.body)

        # ä¸šåŠ¡æˆåŠŸåæ‰ç¡®è®¤æ¶ˆæ¯
        msg.ack()
    except Exception as e:
        # ä¸šåŠ¡å¤±è´¥ï¼Œæ‹’ç»æ¶ˆæ¯ï¼ˆä¼šé‡æ–°æŠ•é€’ï¼‰
        msg.nack(requeue=True)
```

<MessageReliabilityDemo />

### 4.2 æ¶ˆæ¯ä¸é‡å¤

æ¶ˆæ¯å¯èƒ½ä¼šé‡å¤æŠ•é€’ï¼ˆç½‘ç»œæŠ–åŠ¨ã€æ¶ˆè´¹è€…é‡å¯ï¼‰ï¼Œæ‰€ä»¥éœ€è¦**å¹‚ç­‰æ€§**ã€‚

**ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§ï¼Ÿ**

- æ‰§è¡Œä¸€æ¬¡å’Œæ‰§è¡Œå¤šæ¬¡ï¼Œç»“æœç›¸åŒã€‚
- _ä¾‹å­_ï¼š`SET x = 1` æ˜¯å¹‚ç­‰çš„ï¼Œ`INCREMENT x` ä¸æ˜¯ã€‚

**å®ç°å¹‚ç­‰æ€§**ï¼š

```python
# æ–¹æ¡ˆ 1: æ•°æ®åº“å”¯ä¸€çº¦æŸ
def create_order(order_id, user_id, product_id):
    try:
        db.execute(
            "INSERT INTO orders (id, user_id, product_id) VALUES (?, ?, ?)",
            order_id, user_id, product_id
        )
    except DuplicateKeyError:
        # è®¢å•å·²å­˜åœ¨ï¼Œç›´æ¥è¿”å›ï¼ˆå¹‚ç­‰ï¼‰
        return get_order(order_id)

# æ–¹æ¡ˆ 2: Redis å»é‡è¡¨
def process_message(msg):
    message_id = msg.id

    # æ£€æŸ¥æ˜¯å¦å·²å¤„ç†
    if redis.set(f"processed:{message_id}", "1", nx=True, ex=3600):
        # ç¬¬ä¸€æ¬¡å¤„ç†
        handle_business(msg.body)
    else:
        # å·²å¤„ç†è¿‡ï¼Œè·³è¿‡
        log.info(f"æ¶ˆæ¯ {message_id} å·²å¤„ç†ï¼Œè·³è¿‡")
```

<IdempotenceDemo />

### 4.3 æ¶ˆæ¯é¡ºåºæ€§

æŸäº›åœºæ™¯éœ€è¦ä¿è¯æ¶ˆæ¯çš„é¡ºåºï¼ˆå¦‚è®¢å•çŠ¶æ€ï¼šåˆ›å»º â†’ æ”¯ä»˜ â†’ å‘è´§ï¼‰ã€‚

**é—®é¢˜**ï¼šå¤šä¸ªæ¶ˆè´¹è€…å¹¶å‘æ¶ˆè´¹ï¼Œå¯èƒ½å¯¼è‡´é¡ºåºé”™ä¹±ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

1.  **å•åˆ†åŒº / å•é˜Ÿåˆ—**ï¼š
    - æŠŠéœ€è¦æœ‰åºçš„æ¶ˆæ¯å‘åˆ°åŒä¸€ä¸ªåˆ†åŒº/é˜Ÿåˆ—ã€‚
    - ä¸€ä¸ªåˆ†åŒºåªèƒ½è¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ã€‚

```python
# Kafka ç¤ºä¾‹ï¼šæ ¹æ® user_id åˆ†åŒº
producer.send(
    topic="orders",
    value=order_data,
    partition_key=order_data["user_id"]  # åŒä¸€ä¸ªç”¨æˆ·çš„æ¶ˆæ¯ä¼šè¿›å…¥åŒä¸€ä¸ªåˆ†åŒº
)
```

2.  **å†…å­˜æ’åº**ï¼š
    - æ¶ˆè´¹è€…åœ¨å†…å­˜ä¸­ç¼“å­˜æ¶ˆæ¯ï¼Œæ’åºåå†å¤„ç†ã€‚

```python
from collections import defaultdict

messages = defaultdict(list)

def process_message(msg):
    sequence_number = msg.sequence_number
    user_id = msg.user_id

    # ç¼“å­˜æ¶ˆæ¯
    messages[user_id].append((sequence_number, msg))

    # æ’åºå¹¶å¤„ç†
    messages[user_id].sort()
    for seq, m in messages[user_id]:
        if not is_processed(m):
            handle_business(m)
            mark_processed(m)
```

<MessageOrderingDemo />

**å…³é”®ç‚¹**ï¼šå…¨å±€æœ‰åºæ€§èƒ½å·®ï¼Œé€šå¸¸åªéœ€è¦**å±€éƒ¨æœ‰åº**ï¼ˆå¦‚å•ä¸ªç”¨æˆ·çš„æ¶ˆæ¯æœ‰åºï¼‰ã€‚

---

## 5. é«˜çº§ç‰¹æ€§

### 5.1 æ­»ä¿¡é˜Ÿåˆ— (DLQ, Dead Letter Queue)

å¤„ç†æ— æ³•æ¶ˆè´¹çš„æ¶ˆæ¯ã€‚

**åœºæ™¯**ï¼šæ¶ˆæ¯æ ¼å¼é”™è¯¯ã€ä¸šåŠ¡é€»è¾‘å¤±è´¥ï¼ˆé‡è¯• N æ¬¡åä»å¤±è´¥ï¼‰ã€‚

```python
# RabbitMQ ç¤ºä¾‹
queue_args = {
    "x-dead-letter-exchange": "dlx",        # æ­»ä¿¡äº¤æ¢æœº
    "x-dead-letter-routing-key": "dlq",     # æ­»ä¿¡é˜Ÿåˆ—
    "x-max-retries": 3                      # æœ€å¤§é‡è¯•æ¬¡æ•°
}

def process_message(msg):
    try:
        handle_business(msg.body)
        msg.ack()
    except Exception as e:
        msg.retries += 1
        if msg.retries >= 3:
            # è¶…è¿‡é‡è¯•æ¬¡æ•°ï¼Œå‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
            msg.reject(requeue=False)
        else:
            # é‡æ–°å…¥é˜Ÿï¼Œç¨åé‡è¯•
            msg.nack(requeue=True)
```

**æ­»ä¿¡é˜Ÿåˆ—çš„ä½œç”¨**ï¼š

- éš”ç¦»å¼‚å¸¸æ¶ˆæ¯ï¼Œé¿å…é˜»å¡æ­£å¸¸æ¶ˆæ¯ã€‚
- ä¿ç•™å¤±è´¥æ¶ˆæ¯ï¼Œæ–¹ä¾¿åç»­äººå·¥ä»‹å…¥æˆ–åˆ†æã€‚

<DeadLetterQueueDemo />

### 5.2 å»¶è¿Ÿæ¶ˆæ¯ (Delayed Message)

æŒ‡å®šæ—¶é—´åæ‰æ¶ˆè´¹æ¶ˆæ¯ã€‚

**åœºæ™¯**ï¼š

- è®¢å• 30 åˆ†é’Ÿåè‡ªåŠ¨å–æ¶ˆã€‚
- å®šæ—¶æé†’ï¼ˆæ˜å¤© 9 ç‚¹æé†’æˆ‘å¼€ä¼šï¼‰ã€‚

```python
# RocketMQ ç¤ºä¾‹
def send_delay_message(order_id, delay_level):
    # delay_level = 1 è¡¨ç¤º 1s, 2 è¡¨ç¤º 5s, ... 16 è¡¨ç¤º 2h
    producer.send(
        topic="order.cancel",
        body={"order_id": order_id},
        delay_level=14  # 15 åˆ†é’Ÿåå–æ¶ˆ
    )

# Redis + å®šæ—¶ä»»åŠ¡æ–¹æ¡ˆ
def schedule_order_cancellation(order_id, delay_seconds):
    redis.zadd(
        "order.cancellations",
        {order_id: time.time() + delay_seconds}
    )

# å®šæ—¶æ‰«æï¼ˆæ¯ç§’æ‰§è¡Œä¸€æ¬¡ï¼‰
def cancel_expired_orders():
    now = time.time()
    expired_orders = redis.zrangebyscore(
        "order.cancellations",
        0,
        now
    )

    for order_id in expired_orders:
        cancel_order(order_id)
        redis.zrem("order.cancellations", order_id)
```

<DelayedMessageDemo />

### 5.3 äº‹åŠ¡æ¶ˆæ¯ (Transactional Message)

ä¿è¯æœ¬åœ°äº‹åŠ¡å’Œæ¶ˆæ¯å‘é€çš„ä¸€è‡´æ€§ã€‚

**åœºæ™¯**ï¼šè®¢å•åˆ›å»ºæˆåŠŸ â†’ å‘é€"æ‰£å‡åº“å­˜"æ¶ˆæ¯ã€‚

**é—®é¢˜**ï¼šè®¢å•åˆ›å»ºäº†ï¼Œä½†æ¶ˆæ¯æ²¡å‘é€æˆåŠŸï¼ˆç½‘ç»œæ•…éšœï¼‰ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼ˆRocketMQ äº‹åŠ¡æ¶ˆæ¯ï¼‰ï¼š

```python
# 1. å‘é€åŠæ¶ˆæ¯ï¼ˆhalf messageï¼‰
producer.send_half_message(topic="order.deduct_stock", body=order_data)

# 2. æ‰§è¡Œæœ¬åœ°äº‹åŠ¡
def execute_local_transaction(msg):
    try:
        create_order_in_db(msg.body)
        return COMMIT  # æœ¬åœ°äº‹åŠ¡æˆåŠŸï¼Œæäº¤æ¶ˆæ¯
    except Exception as e:
        return ROLLBACK  # æœ¬åœ°äº‹åŠ¡å¤±è´¥ï¼Œå›æ»šæ¶ˆæ¯

# 3. RocketMQ å›æŸ¥ï¼ˆå¦‚æœé•¿æ—¶é—´æœªæ”¶åˆ°ç¡®è®¤ï¼‰
def check_local_transaction(msg):
    order = db.get_order(msg.body["order_id"])
    if order:
        return COMMIT  # è®¢å•å­˜åœ¨ï¼Œè¯´æ˜æœ¬åœ°äº‹åŠ¡æˆåŠŸ
    else:
        return ROLLBACK
```

<TransactionMessageDemo />

**å…³é”®ç‚¹**ï¼šäº‹åŠ¡æ¶ˆæ¯ä¿è¯äº†"è¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥"ã€‚

---

## 6. å®æˆ˜ï¼šè®¾è®¡ä¸€ä¸ªç§’æ€ç³»ç»Ÿ

### 6.1 éœ€æ±‚åˆ†æ

- **é«˜å¹¶å‘**ï¼š1 ç§’å†…æœ‰ 10 ä¸‡ä¸ªè¯·æ±‚ã€‚
- **ä¸è¶…å–**ï¼šåº“å­˜ 100 ä¸ªï¼Œä¸èƒ½å–å‡º 101 ä¸ªã€‚
- **ç”¨æˆ·ä½“éªŒ**ï¼šç«‹å³è¿”å›"æ’é˜Ÿä¸­"ï¼Œè€Œä¸æ˜¯è®©ç”¨æˆ·ç­‰å¾…ã€‚

### 6.2 æ¶æ„è®¾è®¡

```
ç”¨æˆ·è¯·æ±‚
    â†“
[ç½‘å…³] é™æµï¼šåªæ”¾è¡Œ 1 ä¸‡/ç§’
    â†“
[Redis] é¢„æ‰£å‡åº“å­˜ï¼ˆåŸå­æ“ä½œï¼‰
    â†“ æˆåŠŸ
[æ¶ˆæ¯é˜Ÿåˆ—] ç¼“å†²è®¢å•è¯·æ±‚
    â†“
[è®¢å•æœåŠ¡] æ…¢æ…¢åˆ›å»ºè®¢å•
    â†“
[æ¶ˆæ¯é˜Ÿåˆ—] è®¢å•å®Œæˆé€šçŸ¥
    â†“
[é€šçŸ¥æœåŠ¡] å‘é€çŸ­ä¿¡/æ¨é€
```

### 6.3 ä»£ç å®ç°

```python
# ç§’æ€æ¥å£
def seckill(user_id, product_id):
    # 1. Redis é¢„æ‰£å‡åº“å­˜ï¼ˆåŸå­æ“ä½œï¼‰
    stock_key = f"seckill:stock:{product_id}"
    success = redis.eval(
        """
        if redis.call('get', KEYS[1]) > 0 then
            redis.call('decr', KEYS[1])
            return 1
        else
            return 0
        end
        """,
        1,
        stock_key
    )

    if not success:
        return {"error": "åº“å­˜ä¸è¶³"}

    # 2. å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—
    mq.publish(
        "seckill.orders",
        {
            "user_id": user_id,
            "product_id": product_id,
            "timestamp": time.time()
        }
    )

    # 3. ç«‹å³è¿”å›
    return {"status": "æ’é˜Ÿä¸­", "queue_position": get_queue_position()}

# è®¢å•æœåŠ¡æ¶ˆè´¹è€…
def handle_seckill_order(data):
    user_id = data["user_id"]
    product_id = data["product_id"]

    # 1. åˆ›å»ºè®¢å•ï¼ˆæ•°æ®åº“ï¼‰
    try:
        order = db.create_order(user_id, product_id, status="PROCESSING")
    except Exception as e:
        # åˆ›å»ºå¤±è´¥ï¼Œæ¢å¤åº“å­˜
        redis.incr(f"seckill:stock:{product_id}")
        log.error(f"åˆ›å»ºè®¢å•å¤±è´¥: {e}")
        return

    # 2. å‘é€"è®¢å•åˆ›å»ºæˆåŠŸ"æ¶ˆæ¯
    mq.publish(
        "seckill.order.created",
        {
            "order_id": order.id,
            "user_id": user_id,
            "product_id": product_id
        }
    )

# é€šçŸ¥æœåŠ¡æ¶ˆè´¹è€…
def handle_order_created(data):
    order_id = data["order_id"]
    user_id = data["user_id"]

    # 1. å‘é€çŸ­ä¿¡
    sms.send(user_id, f"æ‚¨çš„è®¢å• {order_id} å·²åˆ›å»ºæˆåŠŸ")

    # 2. å‘é€æ¨é€
    push.send(user_id, {"title": "è®¢å•åˆ›å»ºæˆåŠŸ", "body": "..."})

    # 3. æ›´æ–°è®¢å•çŠ¶æ€
    db.update_order_status(order_id, "NOTIFIED")
```

### 6.4 ç›‘æ§ä¸å‘Šè­¦

```python
# ç›‘æ§æŒ‡æ ‡
metrics = {
    "queue_length": mq.get_queue_length("seckill.orders"),      # é˜Ÿåˆ—é•¿åº¦
    "processing_speed": mq.get_processing_speed(),              # å¤„ç†é€Ÿåº¦
    "success_rate": calculate_success_rate(),                    # æˆåŠŸç‡
    "average_latency": calculate_average_latency(),              # å¹³å‡å»¶è¿Ÿ
}

# å‘Šè­¦è§„åˆ™
if metrics["queue_length"] > 10000:
    alert("é˜Ÿåˆ—ç§¯å‹è¿‡å¤šï¼Œè¯·å¢åŠ æ¶ˆè´¹è€…")

if metrics["success_rate"] < 0.95:
    alert("æˆåŠŸç‡è¿‡ä½ï¼Œè¯·æ£€æŸ¥ä¸šåŠ¡é€»è¾‘")
```

<SeckillSystemDemo />

**å…³é”®ç‚¹**ï¼š

- ç”¨ Redis åšç¬¬ä¸€é“é˜²çº¿ï¼ˆå¿«é€Ÿæ‹¦æˆªï¼‰ã€‚
- ç”¨æ¶ˆæ¯é˜Ÿåˆ—åšç¼“å†²ï¼ˆå‰Šå³°ï¼‰ã€‚
- å¼‚æ­¥å¤„ç†çœŸæ­£çš„ä¸šåŠ¡é€»è¾‘ã€‚

---

## 7. æ€»ç»“ä¸å­¦ä¹ è·¯çº¿

æ¶ˆæ¯é˜Ÿåˆ—æ˜¯åç«¯ç³»ç»Ÿçš„"æ ¸å¿ƒåŸºç¡€è®¾æ–½"ï¼ŒæŒæ¡å®ƒèƒ½è®©ä½ çš„ç³»ç»Ÿæ›´å¯é ã€æ›´é«˜æ•ˆã€‚

### 7.1 æ ¸å¿ƒçŸ¥è¯†ç‚¹

| çŸ¥è¯†ç‚¹                 | é‡è¦ç¨‹åº¦   | éš¾åº¦ | å®æˆ˜é¢‘ç‡ |
| :--------------------- | :--------- | :--- | :------- |
| **ç‚¹å¯¹ç‚¹ / å‘å¸ƒè®¢é˜…**  | â­â­â­â­â­ | ä½   | æé«˜     |
| **å‰Šå³°å¡«è°·**           | â­â­â­â­â­ | ä¸­   | æé«˜     |
| **æ¶ˆæ¯å¯é æ€§ï¼ˆä¸ä¸¢ï¼‰** | â­â­â­â­â­ | é«˜   | æé«˜     |
| **å¹‚ç­‰æ€§**             | â­â­â­â­â­ | ä¸­   | æé«˜     |
| **æ¶ˆæ¯é¡ºåº**           | â­â­â­â­   | é«˜   | ä¸­       |
| **æ­»ä¿¡é˜Ÿåˆ—**           | â­â­â­â­   | ä½   | é«˜       |
| **å»¶è¿Ÿæ¶ˆæ¯**           | â­â­â­â­   | ä¸­   | ä¸­       |
| **äº‹åŠ¡æ¶ˆæ¯**           | â­â­â­     | é«˜   | ä½       |

### 7.2 å­¦ä¹ è·¯çº¿

1.  **å…¥é—¨**ï¼ˆ1-2 å¤©ï¼‰ï¼š
    - ç†è§£æ¶ˆæ¯é˜Ÿåˆ—çš„æ ¸å¿ƒæ¦‚å¿µï¼ˆç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ã€Brokerï¼‰ã€‚
    - æŒæ¡ç‚¹å¯¹ç‚¹å’Œå‘å¸ƒè®¢é˜…ä¸¤ç§æ¨¡å¼ã€‚
    - ç”¨ Redis Stream æˆ– RabbitMQ å®ç°ç®€å•çš„å¼‚æ­¥ä»»åŠ¡ã€‚

2.  **è¿›é˜¶**ï¼ˆ1 å‘¨ï¼‰ï¼š
    - å®ç°å‰Šå³°å¡«è°·ï¼ˆå¦‚ç§’æ€ç³»ç»Ÿï¼‰ã€‚
    - ä¿è¯æ¶ˆæ¯å¯é æ€§ï¼ˆæŒä¹…åŒ–ã€ACKã€é‡è¯•ï¼‰ã€‚
    - å®ç°å¹‚ç­‰æ€§ï¼ˆå”¯ä¸€ IDã€å»é‡è¡¨ï¼‰ã€‚

3.  **å®æˆ˜**ï¼ˆ2-4 å‘¨ï¼‰ï¼š
    - è®¾è®¡ä¸€ä¸ªå®Œæ•´çš„å¼‚æ­¥å¤„ç†ç³»ç»Ÿï¼ˆè®¢å•ã€é€šçŸ¥ã€ç§¯åˆ†ï¼‰ã€‚
    - æ¥å…¥ç›‘æ§ï¼Œå®æ—¶è§‚æµ‹é˜Ÿåˆ—é•¿åº¦ã€æ¶ˆè´¹é€Ÿåº¦ã€‚
    - å¤„ç†å¼‚å¸¸åœºæ™¯ï¼ˆæ­»ä¿¡é˜Ÿåˆ—ã€é‡è¯•ç­–ç•¥ï¼‰ã€‚

4.  **æ·±å…¥**ï¼ˆæŒç»­ï¼‰ï¼š
    - å­¦ä¹  Kafka çš„é«˜å¯ç”¨æ¶æ„ï¼ˆå¤šå‰¯æœ¬ã€åˆ†åŒºï¼‰ã€‚
    - ç ”ç©¶ RocketMQ çš„äº‹åŠ¡æ¶ˆæ¯ã€‚
    - æ¢ç´¢æ¶ˆæ¯é˜Ÿåˆ—åœ¨æµå¼å¤„ç†ä¸­çš„åº”ç”¨ï¼ˆFlinkã€Sparkï¼‰ã€‚

### 7.3 æ¨èèµ„æº

- **ä¹¦ç±**ï¼š
  - ã€ŠKafka æƒå¨æŒ‡å—ã€‹
  - ã€ŠRabbitMQ å®æˆ˜æŒ‡å—ã€‹
- **æ–‡ç« **ï¼š
  - RabbitMQ å®˜æ–¹æ–‡æ¡£: https://www.rabbitmq.com/getstarted.html
  - Kafka å®˜æ–¹æ–‡æ¡£: https://kafka.apache.org/documentation/
- **å·¥å…·**ï¼š
  - RabbitMQ Management Plugin (Web ç®¡ç†ç•Œé¢)
  - Kafka Tool (Kafka å¯è§†åŒ–)

---

## 8. åè¯é€ŸæŸ¥è¡¨ (Glossary)

| åè¯                    | å…¨ç§°              | è§£é‡Š                                                                  |
| :---------------------- | :---------------- | :-------------------------------------------------------------------- |
| **MQ**                  | Message Queue     | **æ¶ˆæ¯é˜Ÿåˆ—**ã€‚ç”¨äºå¼‚æ­¥é€šä¿¡çš„ä¸­é—´ä»¶ï¼Œå®ç°ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„è§£è€¦ã€‚        |
| **Producer**            | -                 | **ç”Ÿäº§è€…**ã€‚å‘é€æ¶ˆæ¯çš„ä¸€æ–¹ã€‚                                          |
| **Consumer**            | -                 | **æ¶ˆè´¹è€…**ã€‚æ¥æ”¶å¹¶å¤„ç†æ¶ˆæ¯çš„ä¸€æ–¹ã€‚                                    |
| **Broker**              | -                 | **æ¶ˆæ¯ä»£ç†**ã€‚å­˜å‚¨å’Œè½¬å‘æ¶ˆæ¯çš„æœåŠ¡ç«¯ç¨‹åºã€‚                            |
| **Topic**               | -                 | **ä¸»é¢˜**ã€‚æ¶ˆæ¯çš„é€»è¾‘åˆ†ç±»ï¼ˆå¦‚ "orders"ï¼‰ã€‚                             |
| **Queue**               | -                 | **é˜Ÿåˆ—**ã€‚å­˜å‚¨æ¶ˆæ¯çš„ç‰©ç†å®¹å™¨ã€‚                                        |
| **Partition**           | -                 | **åˆ†åŒº**ã€‚Kafka çš„æ¦‚å¿µï¼Œä¸€ä¸ª Topic å¯ä»¥åˆ†æˆå¤šä¸ª Partitionï¼Œæå‡å¹¶å‘ã€‚ |
| **ACK**                 | Acknowledgment    | **ç¡®è®¤**ã€‚æ¶ˆè´¹è€…å¤„ç†å®Œæ¶ˆæ¯åï¼Œå‘ Broker ç¡®è®¤ã€‚                        |
| **Pub/Sub**             | Publish/Subscribe | **å‘å¸ƒè®¢é˜…**ã€‚ä¸€ç§æ¶ˆæ¯æ¨¡å¼ï¼Œä¸€æ¡æ¶ˆæ¯å¯è¢«å¤šä¸ªæ¶ˆè´¹è€…æ¥æ”¶ã€‚              |
| **P2P**                 | Point-to-Point    | **ç‚¹å¯¹ç‚¹**ã€‚ä¸€ç§æ¶ˆæ¯æ¨¡å¼ï¼Œä¸€æ¡æ¶ˆæ¯åªèƒ½è¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¥æ”¶ã€‚              |
| **DLQ**                 | Dead Letter Queue | **æ­»ä¿¡é˜Ÿåˆ—**ã€‚å­˜æ”¾æ— æ³•æ¶ˆè´¹çš„æ¶ˆæ¯ã€‚                                    |
| **Idempotence**         | -                 | **å¹‚ç­‰æ€§**ã€‚å¤šæ¬¡æ‰§è¡Œç»“æœç›¸åŒã€‚                                        |
| **Throughput**          | -                 | **ååé‡**ã€‚å•ä½æ—¶é—´å†…å¤„ç†çš„æ¶ˆæ¯æ•°é‡ã€‚                                |
| **Latency**             | -                 | **å»¶è¿Ÿ**ã€‚æ¶ˆæ¯ä»å‘é€åˆ°è¢«æ¥æ”¶çš„æ—¶é—´å·®ã€‚                                |
| **Persistence**         | -                 | **æŒä¹…åŒ–**ã€‚æ¶ˆæ¯å†™å…¥ç£ç›˜ï¼Œè€Œéä»…å­˜å†…å­˜ã€‚                              |
| **Replication**         | -                 | **å‰¯æœ¬**ã€‚ä¸ºäº†é«˜å¯ç”¨ï¼Œæ¶ˆæ¯è¢«å¤åˆ¶åˆ°å¤šä¸ªèŠ‚ç‚¹ã€‚                          |
| **Transaction Message** | -                 | **äº‹åŠ¡æ¶ˆæ¯**ã€‚ä¿è¯æœ¬åœ°äº‹åŠ¡å’Œæ¶ˆæ¯å‘é€çš„ä¸€è‡´æ€§ã€‚                        |
